# set the working directory
setwd("/home/tivan/projects/western_cape_housing_market/")

library(glue)
library(targets)
library(writexl)
library(broom)
library(janitor)
library(furrr)
library(parallel)
library(snakecase)
library(tibble)
library(logger)
library(httr)
library(rvest)
library(tidyverse)
source("/home/tivan/projects/western_cape_housing_market/scripts/R/save_consolidated_listings.R")
source("/home/tivan/projects/western_cape_housing_market/scripts/R/get_spes_ad_info.R")
source("/home/tivan/projects/western_cape_housing_market/scripts/R/get_listing_info.R")
source("/home/tivan/projects/western_cape_housing_market/scripts/R/get_all_rental_ads.R")


# first_page <- "https://www.gumtree.co.za/s-house-rentals-flat-rentals-offered/western-cape/v1c9071l3100001p20"

# flats for rent ______________________________________________________________

# Check which have already been done
done_flats <- read_csv("scrape_logs/flat_rentals_log.csv") %>% 
  pull(file_name)

## get the new search data
all_flat_rental_ads <- get_all_rental_ads("https://www.gumtree.co.za/s-house-rentals-flat-rentals-offered/western-cape/v1c9071l3100001p1") %>% 
  filter(!(file_name %in% done_flats)) %>% 
  mutate(ad_num = 1:n())


## get the specific add info and save it
walk2(
  all_flat_rental_ads %>% pull(add_link),
  all_flat_rental_ads %>% pull(ad_num),
  ~get_spes_ad_info(.x, .y, "flat_rentals")
)


# rooms to rent _______________________________________________________________

## Check which have already been done 
done_rooms <- read_csv("scrape_logs/room_rentals_log.csv") %>% 
  pull(file_name)

## get the new search data
new_room_rental_ads <- get_all_rental_ads("https://www.gumtree.co.za/s-flat-share-house-share/western-cape/v1c9075l3100001p1") %>% 
  filter(!(file_name %in% done_rooms)) %>% 
  mutate(ad_num = 1:n()) 

## get the specific add info and save it

walk2(
  new_room_rental_ads %>% pull(add_link),
  new_room_rental_ads %>% pull(ad_num),
  ~get_spes_ad_info(.x, .y, "room_rentals")
)


# houses for rent _____________________________________________________________

## Check which have already been done
done_houses <- read_csv("scrape_logs/house_rentals_log.csv") %>% 
  pull(file_name)

## get the new search data
all_house_rental_ads <- get_all_rental_ads("https://www.gumtree.co.za/s-houses-flats-for-rent/western-cape/v1c9078l3100001p1") %>% 
  filter(!(file_name %in% done_houses)) %>% 
  mutate(ad_num = 1:n()) 

## get the specific add info and save it

walk2(
  all_house_rental_ads %>% pull(add_link),
  all_house_rental_ads %>% pull(ad_num),
  ~get_spes_ad_info(.x, .y, "house_rentals")
)

# Consolidate specific adds -----------------------------------------------


walk(
  c("flat_rentals", "room_rentals", "house_rentals"),
  save_consolidated_listings
)

